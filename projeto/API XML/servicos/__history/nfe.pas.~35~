unit nfe;

interface

uses
  XData.Service.Common,
  parametros,
  regras_nfe,
  System.JSON,
  funcoes,
  XData.Server.Module,
  System.SysUtils,
  dialogs,
  menu;

type
  [ServiceContract]
  [Route('')]
  Infe = interface(IInvokable)
    ['{49034E5D-88BF-479C-BAFF-68C9A8E1E543}']
    [httppost]function  xml(dataInicio,dataFim:TDate;tipoNota:integer):TJSonObject;
    end;
    [ServiceImplementation]
      TInfe = class(TInterfacedObject, Infe)
      private
       function  xml(dataInicio,dataFim:TDate;tipoNota:integer):TJSonObject;
  end;


implementation
 var
  usando:Boolean;





{ TInfe }

function TInfe.xml(dataInicio,dataFim:TDate;tipoNota:integer): TJSonObject;
  var
   resultado      : TJSONObject;
   usuario        : TJSONObject;
   tokenLogado    : string;
 begin
    tokenLogado :=  TXDataOperationContext.Current.Request.Headers.Get('Authorization');
    menu.cliqueNfe := menu.cliqueNfe + 1;

    if menu.cliqueNfe > 1 then
       begin
         if tokenLogado = TXDataOperationContext.Current.Request.Headers.Get('Authorization')  then
         begin
           menu.cliqueNfe := 0;
           Sleep(1500);
         end;
       end;
         usuario  := funcoes.logaToken(TXDataOperationContext.Current.Request.Headers.Get('Authorization'));
              if usuario.FindValue('codigoHttp').value = '200' then
                begin
                      resultado  :=  regras_nfe.emitirXML(dataInicio,dataFim,tipoNota,usuario.P['mensagemRetorno'].FindValue('mensagem').Value);
                      result     :=  TJSonObject.ParseJSONValue(resultado.P['mensagemRetorno'].ToString) as TJSonObject;
                      funcoes.statusHTTP(strtoint(resultado.FindValue('codigoHttp').value));
                end else
                     begin
                       result := TJSonObject.ParseJSONValue(usuario.P['mensagemRetorno'].ToString) as TJSonObject;
                       funcoes.statusHTTP(strtoint(usuario.FindValue('codigoHttp').Value));
                     end;
   tokenLogado := '';
 end;

initialization
  RegisterServiceType(TypeInfo(Infe));
  RegisterServiceType(TInfe);

end.

